---

layout: post
title: 《网络是怎样连接的》笔记
category: 技术
tags: Network
keywords: network device

---

## 简介

* TOC
{:toc}

网络通信由操作系统中的网络控制软件，以及交换机、路由器等设备分工合作来实现的，它的基本思路是将数字信息分割成一个一个的小块，然后装入一些被称为“包”(Packet)的容器中来运送。包相当于信件或者包裹，而交换机和路由器则相当于邮 局或快递公司的分拣处理区。包的头部存有目的地等控制信息，通过许多 交换机和路由器的接力，就可以根据控制信息对这些包进行分拣，然后将 它们一步一步地搬运到目的地。无论是家庭和公司里的局域网，还是外面 的互联网，它们只是在规模上有所不同，基本的机制都是相同的。

## 单机

![](/public/upload/network/network_layer.png)

对于在数据收发中扮演关键角色的套接字，让我们来看一看它具体是个怎样的东西。在协议栈内部有一块用于存放控制信息的内存空间，这里记录了用于 控制通信操作的控制信息，例如通信对象的 IP 地址、端口号、通信操作的 进行状态等。**本来套接字就只是一个概念而已，并不存在实体，如果一定 要赋予它一个实体，我们可以说这些控制信息就是套接字的实体**，或者说 存放控制信息的内存空间就是套接字的实体。

协议栈在执行操作时需要参阅这些控制信息 。例如，在发送数据时， 需要看一看套接字中的通信对象 IP 地址和端口号，以便向指定的 IP 地址 和端口发送数据。在发送数据之后，协议栈需要等待对方返回收到数据的 响应信息，但数据也可能在中途丢失，永远也等不到对方的响应。在这样 的情况下，我们不能一直等下去，需要在等待一定时间之后重新发送丢失 的数据，这就需要协议栈能够知道执行发送数据操作后过了多长时间。为 此，套接字中必须要记录是否已经收到响应，以及发送数据后经过了多长时间，才能根据这些信息按照需要执行重发操作。套接字中记录了用于控制通信操作的各种控制信息，协议栈则需要根据这些信息判断下一步的行动，这就是套接 字的作用。

1. 创建套接字。首先会分配用于存放一个套接字所需的内存空 间。用于记录套接字控制信息的内存空间并不是一开始就存在的，因此我们先要开辟出这样一块空间来 ，这相当于为控制信息准备一个容器。套接字刚刚创建时， 数据收发操作还没有开始，因此需要在套接字的内存空间中写入表示这一 初始状态的控制信息。
2. 连接。以太网的网线都是 一直连接的状态，我们并不需要来回插拔网线，那么这里的“连接”到底 是什么意思呢?连接实际上是通信双方交换控制信息（比如IP和PORT），在套接字中记录这 些必要信息并准备数据收发的一连串操作。连接操作中所交换的控制信息是根据通信规则来确定的， 只要根据规则执行连接操作，双方就可以得到必要的信息从而完成数据收 发的准备。此外，当执行数据收发操作时，我们还需要一块用来临时存放 要收发的数据的内存空间，这块内存空间称为缓冲区，它也是在连接操作 的过程中分配的。通信操作中的控制信息分为两类

    1. 头部中记录的信息/客户端和服务端相互联络时交换的控制信息，这些内容在 TCP 协议的规格中进行了定义。比如发送方/接收方端口号、序号、ACK号、数据偏移量、控制位、窗口、校验和、紧急指针等
    2. 根据协议栈本身的实现方式不同而不同，通信对方是看不见的。例如，Windows 和 Linux 操作系统的内部结构不同，协议栈的实现方式不同，必要的控制信息也就不同。

发送方的网络设备会负责创建包，创建包的过程就是生成含有 正确控制信息的头部，然后再附加上要发送的数据。接下来，包会被发往最近的网络转发设备。当到达最近的转发设备之后，转发设备会根据头部
中的信息判断接下来应该发往哪里。这个过程需要用到一张表，这张表里面记录了每一个地址对应的发送方向，也就是**按照头部里记录的目的地址在表里进行查询**，并根据查到的信息判断接下来应该发往哪个方向。这些对于各种通信方式都是适用的

![](/public/upload/network/network_card.png)

网卡并不是通上电之后就可以马上开始工作的，而是和其他硬件一样， 都需要进行初始化。也就是说，打开计算机启动操作系统的时候，网卡驱 动程序会对硬件进行初始化操作，然后硬件才进入可以使用的状态。这些 操作包括硬件错误检查、初始设置等步骤。

网卡驱动从 IP 模块获取包之后，会将其复制到网卡内的缓冲区中，然后向 MAC 模块发送发送包的命令。MAC 模块会将包从缓冲区中取出，并在开头加上报头和起始帧分界符，在末尾加上用于检测错误的帧校验序列。接下来，PHY(MAU)模块会将信号转换为可在网线上传输的格式， 并通过网线发送出去。PHY(MAU)还需要监控接收线路中有没有信号进来。在开始发送信号之前，需要先确认没有其他信号进来，这时才能开始发送。如果 有其他设备同时发送信号，这些信号就会通过接收线路传进来。在使用集线器的半双工模式中，一旦发生这种情况，两组信号就会相互叠加，无法彼此区分出来，这就是所谓的信号碰撞。这种情况下，继续发送信号是没有意义的，因此发送操作会终止。

接收数据包时，首 先，PHY (MAU)模块会将信号转换成通用格式并发送给 MAC 模块，MAC 模块再 从头开始将信号转换为数字信息，并存放到缓冲区中。当到达信号的末尾 时，还需要检查 FCS。如果 FCS 校验没有问题，接下来就要看一下 MAC 头部中接收方MAC 地址与网卡在初始化时分配给自己的 MAC 地址是否一致，以判断这 个包是不是发给自己的。**我们没必要去接收发给别人的包，因此如果不是 自己的包就直接丢弃**。如果接收方 MAC 地址和自己 MAC 地址一致，则将包放入缓冲区中 通知计算机收到了一个包。


通知计算机的操作会使用一个叫作中断的机制。在网卡执行接收包的 操作的过程中，计算机并不是一直监控着网卡的活动，而是去继续执行其 他的任务。因此，如果网卡不通知计算机，计算机是不知道包已经收到了 这件事的。网卡驱动也是在计算机中运行的一个程序，因此它也不知道包 到达的状态。在这种情况下，我们需要一种机制能够打断计算机正在执行 的任务，让计算机注意到网卡中发生的事情，这种机制就是中断。

具体来说，中断的工作过程是这样的。首先，网卡向扩展总线中的中断信号线发送信号，该信号线通过计算机中的中断控制器连接到 CPU。当产生中断信号时，CPU 会暂时挂起正在处理的任务，切换到操作系统中的 B中断处理程序 。然后，中断处理程序会调用网卡驱动，控制网卡执行相应 的接收操作。网卡驱动被中断处理程序调用后，会从网卡的缓冲区中取出收到的包， 并通过 MAC 头部中的以太类型字段判断协议的类型（除了TCP/IP之外还有 NetWare 的 IPX/SPX， Mac电脑中使用的 AppleTalk等）。如 0080(十六进制)代表IP 协议，网卡驱动就会把这样的包交给 TCP/IP 协议栈。

接下来就轮到 IP 模块先开始工作了，第 一步是检查 IP 头部，确认格式是否正确。如果格式没有问题，下一步就是 查看接收方 IP 地址。（**如果接收方 IP 地址不是自己的地址**，看是否开启了包转发功能）。如果接收方 IP 地址正确，则这个包会被接收下来，如果接收到的包是经过分片的，同一个包的所有分片都具有 相同的 ID。此外，IP 头部还有一个分片偏移量(fragment offset)字段，它 表示当前分片在整个包中所处的位置。根据这些信息，在所有分片全部收 到之后，就可以将它们还原成原始的包。

TCP 模块会根据 IP 头部中的接收方和发送方 IP 地址，以及 TCP 头部中的接收方和发送方端口号来查找对应的套接字。找到对应的套接字之后，就可以 根据套接字中记录的通信状态，执行相应的操作了。例如，如果包的内容 是应用程序数据，则返回确认接收的包，并将数据放入缓冲区，等待应用 程序来读取;如果是建立或断开连接的控制包，则返回相应的响应控制包， 并告知应用程序建立和断开连接的操作状态。

严格来说，TCP 模块和 IP 模块有各自的责任范围，TCP 头部属于 TCP 的 责任范围，而 IP 头部属于 IP 模块的责任范围。应该对两者 进行明确的划分，IP 模块只向 TCP 模块传递 TCP 头部以及它后面的数据， 而对于 IP 头部中的重要信息，即接收方和发送方的 IP 地址，则由 IP 模块 以附加参数的形式告知 TCP 模块。然而，如果根据这种严格的划分来开发 程序的话，IP 模块和 TCP 模块之间的交互过程必然会产生成本，而且 IP 模块和 TCP 模块进行类似交互的场景其实非常多，总体的交互成本就会很 高，程序的运行效率就会下降。因此，就像之前提过的一样，不妨将责任 范围划分得宽松一些，将 TCP 和 IP 作为一个整体来看待，这样可以带来 更大的灵活性。

## 交换机

交换机的设计是将网络包原样 转发到目的地

![](/public/upload/network/exchange.png)

信号到达网线接口，并由 PHY(MAU)模块进行接收。它的接口和 PHY(MAU)模块也是以MDI-X传递给 MAC 模块。MAC 模块将信号转换为数字信息，然后通过包末尾的FCS校验错误，如果没有问题则存放到缓冲区中。网线接口 和后面的电路部分加在一起称为一个端口，也就是说交换机的一个端口就相当于计算机上的一块网卡。但交换机的工作方式和网卡有一点不同。网 卡本身具有 MAC 地址，并通过核对收到的包的接收方 MAC 地址判断是不是发给自己的，如果不是发给自己的则丢弃;相对地，交换机的端口不 核对接收方 MAC 地址，而是直接接收所有的包并存放到缓冲区中。因此，和网卡不同，**交换机的端口不具有 MAC 地址**。

将包存入缓冲区后，接下来需要查询一下这个包的接收方 MAC 地址是否已经在 MAC 地址表中有记录了。MAC 地址表主要包含两个信息，一个是设备的 MAC 地址，另一个是该设备连接在交换机的哪个端口上。MAC 地址和端口是一一对应的，通过这张表就能够判断出收到的包应该转发到哪个端口。

当网络包通过交换电路到达发送端口时，端口中的 MAC 模块和 PHY (MAU)模块会执行发送操作，将信号发送到网线中，这部分和网卡发送信 号的过程是一样的。


MAC地址表的维护：收到包时，将发送方 MAC 地址以及其输入端口的号码写入 MAC 地址表中。由于收到包的那个端口就连接着发送这个包的设备，所以 只要将这个包的发送方 MAC 地址写入地址表，以后当收到发往这个地址 的包时，交换机就可以将它转发到正确的端口了。交换机每次收到包时都 会执行这个操作，因此只要某个设备发送过网络包，它的 MAC 地址就会 被记录到地址表中。

## 路由器

![](/public/upload/network/router.png)

路由器包括转发模块和端口模块两部分，其中转发模块负责判断包的转发目的地，端口模块负责包的收发操作。路由器转发模 块和端口模块的关系，就相当于协议栈的 IP 模块和网卡之间的关系。

通过更换网卡，计算机不仅可以支持以太网，也可以支持无线局域网， 路由器也是一样。如果路由器的端口模块安装了支持无线局域网的硬件， 就可以支持无线局域网了。此外，计算机的网卡除了以太网和无线局域网 之外很少见到支持其他通信技术的品种，而路由器的端口模块则支持除局域网之外的多种通信技术，如 ADSL、FTTH，以及各种宽带专线等，只要端口模块安装了支持这些技术的硬件即可。

路由器在转发包时，首先会通过端口将发过来的包接收进来，这一步的工 作过程取决于端口对应的通信技术。对于以太网端口来说，就是按照以太 网规范进行工作，而无线局域网端口则按照无线局域网的规范工作，总之 就是委托端口的硬件将包接收进来。接下来，转发模块会根据接收到的包 的 IP 头部中记录的接收方 IP 地址，在路由表中进行查询，以此判断转发 目标。然后，转发模块将包转移到转发目标对应的端口，端口再按照硬件 的规则将包发送出去。

以以太网端口为例，路由器的端口具有 MAC地址，因此它就能够成为以太网的发送方和接收 。端口还具有 IP 地址，从这个意义上来说，它和计算机的网卡是一样的（端口是按照以太网规范接收包的，即当端口的 MAC 地址和包的接收方MAC 地址一致时，端口才接受这个包，否则就丢弃包）。这一点和交 换机是不同的，交换机只是将进来的包转发出去而已，它自己并不会成为 发送方或者接收方。



无论是路由器的路由表 还是计算机中的 路由表，它们的结构和功能都是相同的。

1. 目标地址destination，记录的是接收方的信息
2. 子网掩码，表示在匹配网络包目标地址时需要对比的比特数量。子网掩码 0.0.0.0 的意思是网络包接收方 IP 地址和路由表目标地址 的匹配中需要匹配的比特数为 0，换句话说，就是根本不需要匹配。
3. 网关，表示网络包的转发目标
4. 接口，表示网络包的转发目标
5. 跃点数，表示距离目标 IP 地址的距离是远还是近

||交换机|路由器|
|查表判断转发目标|MAC地址表|路由表|
|查表判断转发目标|通过 MAC 头部中的接收 方 MAC 地址|根据 IP 头部中的 IP 地址|
|查表判断转发目标|只匹配完全一致的记录|忽略主机号部分，只匹配网络 号部分|
||不具有 MAC 地址|端口具有MAC和IP地址|
|维护方式|对 MAC 地址表的维护是包转发操作中的一个步骤|对路由表的维护是与包 转发操作相互独立的|
|如果无法找到匹配的记录|将包发送到所有的端口上|路由器会丢弃这个包，并通过 ICMP 消息告知发送方 <br>通过默认路由发给默认网关|
|附加功能||地址转发<br>包过滤|


从路由表中查找到转发目标之后，更新 IP 头部中的 TTL，TTL 字段表示包的有效期，包每经过一个路由器的 转发，这个值就会减 1，当这个值变成 0 时，就表示超过了有效期，这个包就会被丢弃（这个机制是为了防止包在一个地方陷入死循环）。路由器的端口并不只有以太网一种，也可以支持其他局域网或专线通信技术。不同的线路和局域网类型各自能传输的最大包长度也不同，因此 输出端口的最大包长度可能会小于输入端口，遇到这种情况，可以使用 IP 协议中定义的分片功能对包进行拆分，缩 短每个包的长度。

接下来就会进入包的发送操作，这一步操作取决于输出端口的类型。如果是以太网端口，则按照以太
网的规则将包转换为电信号发送出去;如果是 ADSL 则按照 ADSL 的规则来转换，以此类推。如果输出端口是以太网，为了判断 MAC 头部中的 MAC 地址应该填写什么值，我们需 要根据路由表的网关列判断对方的地址。如果网关是一个 IP 地址，则这个IP 地址就是我们要转发到的目标地址;如果网关为空方 IP 地址就是要转发到的目标地址。知道对方的 IP 地址之后，接下来需 要通过 ARPD 根据 IP 地址查询 MAC 地址，并将查询的结果作为接收方MAC 地址。路由器也有 ARP 缓存，因此首先会在 ARP 缓存中查询，如果 找不到则发送 ARP 查询请求。接下来是发送方 MAC 地址字段，这里填写输出端口的 MAC 地址 还有一个以太类型字段，填写 0080(十六进制)。网络包完成后，接下来会将其转换成电信号并通过端口发送出去。这 一步的工作过程和计算机也是相同的。

这里讲的内容只适用于原原本 本实现 IP 和以太网机制的纯粹的路由器和交换机，实际的路由器有内置交 换机功能的，比如用于连接互联网的家用路由器就属于这一种。

接入互联网的设备数量快速增长，为解决地址不足的问题，考虑到两家公司的内网之 间不会有网络包流动，公司内部设备的地址可以和其他公司重复，从而大幅节省了 IP 地址。因此需要设置一定的规则，规定某些地址是用于内网的，内网中的设备不能和互联网直接收发网络包。

```
10.0.0.0 ~ 10.255.255.255 
172.16.0.0 ~ 172.31.255.255 
192.168.0.0 ~ 192.168.255.255
```

公司内网并不是完全独立的，而是需要通过互联网和其他很多公司相连接， 所以当内网和互联网之间需要传输包的时候，通过“地址转换”机制进行连接。地址转换的基本原理是在转发网络包时对 IP 头部中的 IP 地址和端口 号 进行改写。然后，**改写前的私有地址 和端口号，以及改写后的公有地址和端口号，会作为一组相对应的记录保 存在地址转换设备内部的一张表中`<公有地址|端口号|私有地址|端口号|>`**（在对外只能使用一个公有地址的情况下，可以用不同的端口号来区别内网中的 不同终端）。从互 联网一端来看，实际的通信对象是地址转换设备(这里指的是路由器)。PS：iptables 命令行方式看着就没有表格方式直接。

包过滤就是在对包进行转发时，根据 MAC 头部、IP 头部、TCP 头部的内容 事先设置好的规则决定是转发这个包，还是丢弃这个包。我们通常说的防火墙设备或软件，大多数都是利用这一机制来防止非法入侵的。