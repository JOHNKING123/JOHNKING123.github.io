---
layout: post
title: OpenTSDB
category: 技术
tags: Hadoop
keywords: OpenTSDB
---

## 前言 (未完成)

网站主页 [opentsdb](http://opentsdb.net/)

[Opentsdb简介（一）](http://www.jianshu.com/p/0bafd0168647)

OpenTSDB is a distributed, scalable Time Series Database (TSDB) written on top of HBase

重点就是两个事情：实现架构；数据存储格式

突击官方文档与实践相结合


## 架构实现

1. OpenTSDB is primarily achieved by running one or more of the TSDs（ Time Series Daemon）. Each TSD is independent.
2. store and retrieve time-series data
3. There is no master, no shared state so you can run as many TSDs as required to handle any load you throw at it.


![](/public/upload/hadoop/open_tsdb_1.png)

可以看到

1. 底层是hbase 存储
2. 中间是 Time Series Daemon (TSD) 
3. 周边是 运行在各个server 的collector，web ui，脚本等

## 简单使用


## 数据结构

time series 基本构成：

1. A metric name.
2. A UNIX timestamp
3. A value,  (64 bit integer or single-precision floating point value)
4. A set of tags (key-value pairs) that describe the time series the point belongs to.

**这种存储结构是后面一堆儿事儿（约束、原则、规范）的核心**


	mysql.bytes_received 1287333217 327810227706 schema=foo host=db1
	mysql.bytes_sent 1287333217 6604859181710 schema=foo host=db1
	mysql.bytes_received 1287333232 327812421706 schema=foo host=db1
	mysql.bytes_sent 1287333232 6604901075387 schema=foo host=db1
	mysql.bytes_received 1287333321 340899533915 schema=foo host=db2
	mysql.bytes_sent 1287333321 5506469130707 schema=foo host=db2

名词解释

|名词|指的是|数量|
|---|---|---|
|metric|mysql.bytes_received/mysql.bytes_sent|2个|
|data point| 每一个记录|6 个|
|time series|metric 和 tag 的不同组合|4个|、

4个 time series 分别是，schema 都是 foo 可以忽略

1. 	mysql.bytes_received + host=db1
2. 	mysql.bytes_received + host=db2
3. mysql.bytes_sent + host=db1
4. 	mysql.bytes_sent + host=db2


基于这个基本结构

1. 如何节省存储空间？**opentsdb 有两张表，一张表存储数据本身，一张表存储 metric name、tag name、tag value 到一个unique id 的映射关系（uid 表）**。metrics, tag name, tag value的编码长度都是3byte, 所以UID的数量上限为 2^24 个。
2. 如果提高查询效率？The underlying data schema will store all of the same time series next to each other so that aggregating the individual values is very fast and efficient
3. 查询方式

## tag

naming schema 命名规则

Tags allow you to separate similar data points from different sources or related entities, so you can easily ** graph them ** individually or in groups. tag 的最大作用是：方便各种条件的聚合查询。也就是，一个数据有多个维度，支持多个维度的聚合查询。the uniqueness comes from a combination of tag key/value pairs that allows for flexible queries with very fast aggregations.

大部分人的查询习惯，都是先看metric 总的数据，然后tagA 情况下的数据，然后tagA + tagB 情况下的数据，即 drill down。

tag 方式的副作用

1. 假设 time series 有两个tag， 那么根据一个tag 去查询，则另一个tag的所有数据都会被匹配。这有时会带来一些不便。


A critical（重要的） aspect of any naming schema is to consider the cardinality（基数） of your time series. 任何命名规则（映射关系） 都必须考虑 命名的基数，比如月份，就是1~12. 比如，如果你将ip 地址作为 一个tag，则ip tag value 共有4 billion 中可能值	，而 一个tag value 最多允许 16 million 中可能值。


OpenTSDB creates a new row per time series per hour


## 存储结构

[解密OpenTSDB的表存储优化](https://yq.aliyun.com/articles/54785)

## tips

1. opentsdb 由java编写，启动方式类似hadoop、zookeeper 等 二进制脚本包裹的方式
2. 第一次启动时候，运行指定脚本创建hbase表
3. OpenTSDB can be configured via a file on the local system, via command line arguments or a combination or both.
6. [Querying or Reading Data](http://opentsdb.net/docs/build/html/user_guide/query/index.html)

## 优化措施


2. 尽管时间戳可以存储到 毫秒，但返回的结果还是按秒的