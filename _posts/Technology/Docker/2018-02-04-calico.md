---

layout: post
title: calico
category: 技术
tags: Docker
keywords: Docker, calico

---


## 简介


Calico是一个纯3层的数据中心网络方案（也就是局域网网络方案），能够提供可控的VM、容器、裸机之间的IP通信。

## 二层网络与三层网络

[二层网络结构和三层网络结构的对比](https://www.jianshu.com/p/81b8f409a2bb)在这里的二层、三层是按照逻辑拓扑结构进行的分类，并不是说ISO七层模型中的数据链路层和网络层，而是指核心层，汇聚层和接入层，这三层都部署的就是三层网络结构，二层网络结构没有汇聚层。

1. 二层交换机根据MAC地址表进行数据包的转发，有则转发，无则泛洪。即将数据包广播发送到所有端口，如果目的终端收到给出回应，那么交换机就可以将该MAC地址添加到地址表中。但频繁这样做，在大规模网络架构中会形成网络风暴，限制了二层网络的规模。
2. [三层交换机工作原理](http://blog.csdn.net/nice_wen/article/details/77821884)文中提到了vlan场景下的三层交换过程。如果来一个非同一网段ip1，交换机可以通过查询过程建立ip1与port1 的映射关系，此后，去向ip1的包直接由port1转发。

[为什么三层交换机无法替代路由器？ - 萧骁的回答 - 知乎](https://www.zhihu.com/question/20843778/answer/95755365)提高三层交换机与路由器的区别时提到：

1. 三层交换机，本质是维护mac与port的关系，路由过程只是在找不到mac与port的关系时进行。同时因为交换机多用于局域网场景（尽管有的局域网很大），其路由能力有限。
2. 路由器，本质是维护ip与port的关系，其处理过程从不涉及mac。路由器的重点是向网络中广播和更新自己的路由信息。

交换机，维基百科解释：是一个扩大网络的器材，能为子网络中提供更多的port，以便连接更多的电脑。

## calico

### calico 架构

![](/public/upload/docker/calico_framework.png)

### calico 思想/原理（未完成）

分析ip route 命令的输出是什么意思

### calico 使用

1. The calicoctl command line interface provides a number of resource management commands to allow you to create, modify, delete, and view the different Calico resources.

### calico 文档使用建议

GitHub [projectcalico/calico](https://github.com/projectcalico/calico)

[官网](https://docs.projectcalico.org)

![官网](/public/upload/docker/calico.png)

1. 官网有对应各个平台的安装文档
2. calico 版本不同，安装细节也有所不同。并且，文档中所说的版本跟calicoctl 的版本不一致。
3. calico 最新版本 不再支持 mesos

## 与编排工具整合

### k8s安装步骤

k8s安装几个要点：

1. 必选先搞懂tls [ssl证书是什么东西](http://qiankunli.github.io/2017/06/11/ssl.html)
1. 搭建etcd集群 [如何搭建安全的ETCD集群](https://supereagle.github.io/2017/05/11/secure-etcd/)。下载tar.gz包，寻找etcd.service 模板，以systemctl启停etcd。安装etcd时不必拘泥后续对k8s和calico的支持，通用就行，忽略不必要的细节。
2. 对于master 运行scheduler、controller-manager、apiserver 可以直接用容器的方式运行（不建议这种方式），也可以下载二进制文件执行运行（寻找相关xx.service模板，以systemctl启停）。

参考文章：

1. [Kubernetes 1.8.x 全手动安装教程](https://www.kubernetes.org.cn/3096.html)

### mesos 安装步骤

[CONFIGURING A MESOS/MARATHON CLUSTER ON UBUNTU 16.04](http://www.admintome.com/blog/configuring-a-dcos-cluster-on-ubuntu-16-04/)


### 几个基本问题

1. 理论上k8s 是编排工具，calico 是网络工具，为何在calico的安装文档上，通常有k8s的存在？
2. calico 与 k8s 集成 与calico 与 mesos 集成有何不同？单纯的与docker 集成有何不同？
3. calico 基础服务的启动方式演化


对于第一个问题

1. 默认 Pod/Container 是未隔离的

1. [Namespaces | Kubernetes](https://kubernetes.io/docs/concepts/overview/working-with-objects/namespaces/) Kubernetes supports multiple virtual clusters backed by the same physical cluster. These virtual clusters are called namespaces，也就是一个物理集群可分为多个虚拟集群。
2. [Network Policy](https://feisky.gitbooks.io/kubernetes/concepts/network-policy.html)。当k8s想控制 namespace 之间是否可以 互通时，便要求网络组件能够根据 k8s 的指令做出反应。k8s 介入了网路，便有了和网络组件的沟通规范，就像docker和网络组件的接口一样。 正像calico github 上介绍的一样 Calico is an open source system enabling cloud native application connectivity and policy ，calico 除了支持 connectivity，还支持policy。

对于第二个问题：

1. 容器集群使用calico 有两种方式 [Calico Networking for Mesos](https://docs.projectcalico.org/v1.5/getting-started/mesos/)

    1. calico 仅服务于docker，k8s/mesos 作为编排工具，不介入网络配置
    2. calico 根据cni 模型 直接与 k8s/mesos 集成，
1. calico 单纯的与docker 集成 和 calico 直接与k8s/mesos 集成，差异很大，前者属于cnm 模型，后者属于 cni 模型。大体来说，cnm 要求 network driver 与docker 交互。cni 则只是编排工具命令docker 创建完network namespace后，编排工具通过 提供cni接口的network tool 直接设置 network namespae。
2. 体现在代码上

    * 与docker集成。安装完calico后，创建容器执行`docker network create --driver calico --ipam-driver calico-ipam --subnet=192.0.2.0/24 my_net`
    * 与k8s或mesos 直接 集成。需要下载calico与calico-ipam 工具
    

对于第三个问题，calico的安装分为以下几个阶段

1. calico 由felix（calico agent）、bgp client、bgp route reflector等组成，这些组件是下载二进制分别安装的
2. 新版Calico服务是作为容器来运行的
3. 将容器的启停配置为systemd service 文件，通过systemd 控制


## 杂

### 从无到有安装mesos + docker

1. [Requirements for Calico with Mesos](https://docs.projectcalico.org/v2.6/getting-started/mesos/installation/prerequisites)
2. [Launching Tasks](https://docs.projectcalico.org/v2.6/getting-started/mesos/tutorials/launching-tasks)

### 对calico细节的认识

[docker 容器网络方案：calico 网络模型](http://cizixs.com/2017/10/19/docker-calico-network)

1. `quay.io/calico/node:latest` 包括calico 功能，也包括calico docker libnetwork 驱动。启动该容器后，`docker network create` 创建网络，然后就可以创建容器执行了。再进一步，就可以marathon 根据json 启动执行了[Launching Tasks](https://docs.projectcalico.org/v2.6/getting-started/mesos/tutorials/launching-tasks)。启动 `quay.io/calico/node:latest` 是最好做成systemd[Kubernetes 1.8.x 全手动安装教程](https://www.kubernetes.org.cn/3096.html)。
2. [集成Docker和Calico网络](http://blog.csdn.net/jiangshouzhuang/article/details/52822125) calico 基本服务器启动之后，根据calico 提供的tool 可以直接设置一个net=none 的容器
3. 推论 cni/calico-ipam cni/calico 是符合cni 接口的插件，调用calico 服务，配置容器
4. calico 服务启动后，有默认ip pool，[Docker网络解决方案-Calico部署记录](http://www.cnblogs.com/kevingrace/p/6864804.html) 说明了如何修改ip pool

结论：

老版本`calico/node calico-libnetwork`/新版本`quay.io/calico/node:lates` 提供了calico的基本能力，然后

* `docker network create` `docker run`  直接玩耍
* cni/calico-ipam cni/calico 通过cni 操作calico
