---

layout: post
title: 微服务梳理
category: 技术
tags: Architecture
keywords: dubbo micro service

---

## 简介

## 三大基本套路

微服务架构是什么

2. rpc、调用信息序列化 等基本能力
1. 服务发现、路由、监控报警 等旁路系统
2. 分拆业务 的一种方式


服务发现、路由、监控报警 等事情 谁去干

1. 以框架为中心
2. 以PaaS 平台为中心，将 公共的 技术能力沉淀到 PaaS层，运维不再只是提供 物理机/jvm 虚拟机，而是提供一个服务，服务的访问形式是ip:port/http url。PaaS 内部负责服务发现、负载均衡等能力等
3. service mesh


本文主要以框架的方式 来阐述微服务治理，主要包括两个方面：“业务层面”（解决有什么）和工程层面（解决如何实现）。此外，篇幅有限，多从客户端角度来阐述问题。

## 从0 到 1 实现一个服务治理框架

### 基本能力

包括且不限于以下问题：

1. io通信
1. 序列化协议


同步模型，请求 ==> 线程 ==> 获取一个连接 ==> 阻塞。此时一个请求将占用一个线程，一个连接。阻塞分为 

1. io阻塞，比如connect、read 等
2. 业务阻塞，服务端bug或负载很大，无法及时返回响应，会表现为客户端read 一直阻塞

异步的话，请求 ==> 线程 ==> 获取一个连接 ==> 发请求 ==> 接口调用结束。
异步的问题在于，通过队列缓冲了请求，若是客户端请求的速度远超服务端响应的速度， 队列会增长，会oom

[qiankunli/pigeon](https://github.com/qiankunli/pigeon) 笔者基于netty 实现了一个基本的rpc 框架，推荐用来熟悉上述过程。

### 旁路系统

1. 客户端，从上到下依次是：

	1. 熔断
	2. 服务发现
	3. 路由
	4. 负载均衡
	5. 调用策略

2. 服务端

	1. 服务注册
	2. 线程隔离

假设一个服务有3个实例ABC，称为集群cluster，客户端去调用A

1. failfast，A 实例故障，则调用失败
2. failover，A 实例故障，则重试BC
3. failsafe，A 实例故障，返回实现配置的默认值

额外提一个问题：框架实现的哪些功能部分适合下放到PaaS 层去做？

## 工程实现

### 实现基本能力

假设存在一个web服务，接收请求，调用rpc 服务处理请求，则按照传统controller-service-dao 的方式，会如何组织代码？

	controller
	service
	CircuitBreaker
	route
	loadbalance
	serialize/codec 
	socket
	
很明显service 层以下，是框架应该解决的部分，不应该直接暴露在业务代码中，因此类似于传统访问db 的方式：

	controller
	service
	micro service
	
自然的，service 与 micro service 之间会定义一个接口（下文成为Iface），客户端调用该接口，服务端则提供接口实现。

我们先只考虑基础能力的实现，则对于客户端来说，Iface 实现Impl 的实现逻辑大体是

1. 将参数序列化
2. 使用socket 发送调用数据，包括但不限于类名、方法名、方法参数及其它信息，比如为分析调用链路 而设置的链路id
3. 读取服务端返回，并将返回结果反序列化

在实际的实现中，这一步骤通常是自动生成的，比如thrift

### 如何聚合旁路系统

基于上文的基本实现，很直观的，我们可以将聚合旁路系统的问题 抽象为一个 如何在已有代码上 “加私货” 的问题。很自然的，会想到使用java 代理 拦截Iface 方法执行，然后加入旁路系统的相关代码。

每一个旁路子系统都有一系列的配置，在聚合的过程中，还需拉取这些配置。配置有以下来源

1. xml 文件
2. 后端管理界面 及其存储数据的 db
3. zk node
4. 用户代码中的注解


## 微服务不是银弹

### 带来的问题

单体服务 ==> 通过 rpc 分割为微服务  ==> 带来以下问题：

1. 查看日志 定位问题要看好几台机器
2. 调用链路 较长的情况下，网络通信也是一种开销
3. 一个服务出现问题，容易在整个微服务网络蔓延（通过熔断器部分解决）


### 拆分服务

拆分服务的几种考虑：

1. 服务下沉： 将具有两个以上使用者的服务下沉，使其成为一种基础服务。
2. 将负载不一致的几个服务拆分，减少彼此的相互影响
3. 将关键链路的服务拆分，减少代码迭代对关键链路的影响

### 服务编排

[微服务编排](http://qiankunli.github.io/2017/11/20/micro_service_arrange.html)

笔者个人订阅号

![](/public/upload/qrcode_for_gh.jpg)