---

layout: post
title: 计算机网络tips
category: 技术
tags: Architecture
keywords: network

---

## 简介

## 网路通信

本小节来自《Paas实现与运维管理》的笔记。

我们将网络世界的物理设备抽象为三种：计算节点，交换节点和路由节点

1. 因为计算节点不能两两相连，所以我们需要一个交换节点，负责**转发数据**。在数据链路层范围内

	* 计算节点在发送数据的时候，**应用程序中**不可能直接写目的主机的mac地址，所以我们需要一个虚拟地址，即ip地址。arp请求（广播）及arp缓存。
   * 交换节点收到一个包，在转发这个包的时候，没有mac地址与端口的映射，会先广播，然后建立mac地址与串口的映射关系。
    
2. 因为一个交换节点负责不了世界上的所有计算节点，（不然广播域也太大了），所以我们需要一个路由节点。

	* 计算节点在发送数据时，通过**ip+掩码**来判断目的计算节点是否在一个子网内。当发现不在一个子网时，它会将数据包发送给子网内的路由节点（也就是网关）。
   * 路由器根据路由表中的策略来接收和发送包。**这就不能叫转发了**，因为路由器会修改数据包。路由表中的rule可以静态设置，也可以动态学习。
    
修正自己以前的几个误区：

1. 除了功能不同，交换节点和路由节点的另一个区别：交换节点并不修改package
2. 实际上，计算节点通过交换节点向路由节点发送数据，交换节点转发包可以理解为透明。所以是：`计算节点 ==> 路由节点 ==> 计算节点 `实现跨网络传输
3. 不仅计算节点有数据通信，路由节点也有数据通信
4. 计算节点的广播（arp），交换节点的广播，路由节点的广播（RIP路由协议）。广播有的时候是为了请求信息，有点时候是为了通知。

## 网关和路由器

[网关，默认网关，自动网关，路由，网关与路由器的关系](http://blog.csdn.net/hzhsan/article/details/44059861)

在没有路由器的情况下，两个网络之间是不能进行TCP/IP通信的，即使是两个网络连接在同一台交换机（或集线器）上，TCP/IP协议也会根据子网掩码（255.255.255.0）判定两个网络中的主机处在不同的网络里。而要实现这两个网络之间的通信，则必须通过网关。

如果网络A中的主机发现数据包的目的主机不在本地网络中，就把数据包转发给它自己的网关，再由网关转发给网络B的网关，网络B的网关再转发给网络B的某个主机。

路由器使用静态路由或动态路由来决定网络间的最短路径。

从网关和路由器的定义来看，如果只是简单地连接两个网络，那么只需要网关就足够了。因为只有两个网络，不需要决定网络间最短路径。如果需要连接多个网络，为了保证网络的可靠性，网络结构需要设计为全网状或部分网状，这样，为了网络间的通信，需要网关和路由器两种设备(比如网络A到网路D有两种路径，A-B-D/A-C-D，需要网关连通B和C，需要路由器决策选取哪种路径)，因为当前路由器集成了网关的功能，所以只使用路由器一种设备就可以了。

抛开这些陈年往事，从现在情境看，**网关实质上是一个网络通向其他网络的IP地址。**路由器是一个设备,可以做网关使用。它是一种连接多个网络或网段的网络设备，从而构成一个更大的网络。




## linux 的路由表

笔者的直观感受 一直是，路由是路由器做的事儿，既然如此，为了linux 中还有一个路由表? 

普通的主机与路由器之间的根本区别在于，主机不会将一个报文从一个接口转发到另一个接口，而路由器可以转发报文。但是，一个普通路由算法可以被用在路由器上，同样也可以用在一台普通主机上。当一台主机可以用作路由器时，我们通常说这台主机嵌入了路由器的功能。这种具备嵌入路由器功能的主机平常不会转发报文，除非我们对它进行了配置，使它开启这种功能。

[Linux路由分析](http://www.just4coding.com/blog/2016/12/10/linux-route/)提到： Linux默认情况下会丢掉不属于本机IP的数据包。将`net.ipv4.ip_forward`设置为1后，会开启路由功能，Linux会像路由器一样对不属于本机的IP数据包进行路由转发。linux 有路由表，是因为开启了路由功能。


	root@ubuntu-1:/home/ops# ip route
	default via 10.0.2.2 dev enp0s3
	10.0.2.0/24 dev enp0s3  proto kernel  scope link  src 10.0.2.15
	172.17.0.0/16 dev docker0  proto kernel  scope link  src 172.17.0.1 linkdown
	172.32.135.128/26 via 192.168.56.103 dev tunl0  proto bird onlink
	blackhole 172.32.185.64/26  proto bird
	172.32.185.70 dev calie34960bc671  scope link
	172.32.185.71 dev cali6d5e7989019  scope link
	172.32.243.0/26 via 192.168.56.102 dev tunl0  proto bird onlink
	192.168.56.0/24 dev enp0s8  proto kernel  scope link  src 192.168.56.101
	
如何看待这个输出 [route table explanation](https://askubuntu.com/questions/72733/route-table-explanation)

proto,发现该路由的路由协议(即路由来源)，一般是协议名，proto kernel 表示 The route was installed by the kernel during autoconfiguration.

scope,The scope of a route in Linux is an indicator of the distance to the destination network. 

* Link-local address are supposed to be used for addressing nodes on a single link. Packets originating from or destined to a link-local address will not be forwarded by a router. 还有一种说法 valid only on this device
* Site,valid only within this site (IPv6)
* Host,A host address is something that will only exist within the host machine itself. For instance 127.0.0.1 is a host address commonly assigned to the loopback interface. The loopback interface has no external connectivity and so it's scope is confined to within that of the host machine.
* A global address is what you might currently consider a "normal" address. Global which is visible on and routable across an external network.