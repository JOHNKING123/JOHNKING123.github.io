---

layout: post
title: 平台支持类系统的几个点
category: 技术
tags: Architecture
keywords: abtest

---

## 简介（未完成）

此处主要指 客户端版本管理系统、配置中心系统、abtest 系统、上传系统、推送系统等 跟app 业务不直接关联，但仍是每个app 的必要的 “业务” 系统。

平台支持 系统 是笔者用以对这几个系统的统称，他们与一般业务系统有以下不同

1. 一般业务系统 请求 ==> 响应 ==> 展示给用户 就结束了。而平台支持类系统则是 请求 ==> 响应 ==> 数据存在本地 ==> 在恰当的时机生效。
2. 客户端 本地数据 需要与服务端 做同步
3. 如果将app 分为 业务/基础环境 两个层次的话，其运行属于“基础环境”的一部分

下文以一个文件下发系统为例，即app 启动时/某个业务点击时 向服务端拉取 适配客户端的文件，客户端下载文件 并应用在本地。

平台支持类系统 有很多的共同点，这也就意味着，很多共同点可以作为框架抽取出来。

## 几个基本的功能点

### 匹配

1. 条件匹配，将文件推送符合一定特征的用户

	* 设备信息，比如android/ios 等
	* app 信息，比如版本号、渠道号
	* 用户画像信息，比如儿童、老人等
	* 测试信息，比如请求来自一个内部测试设备，可以访问未发布的文件

2. 精确匹配，将文件推送给一个hdfs 文件（用户id 列表）

![](/public/upload/architecture/client_support_match.png)

假设client 十几个properties，服务端资源十几个properties， 匹配算法有两个方面

1. 提高每一个资源匹配的速度
2. 避免重复计算，一般使用缓存

主要思路

||单个匹配速度|避免重复计算|
|---|---|---|
|使用es|es解决|es解决|
|哈希|每个property 依次匹配|将client 十几个properties 组成一个字符串 作为cache key|

针对哈希算法，有以下优化的变种

1. properties 按区分度 分为base 和 optional，使用base 作为cache key做初步过滤，对“漏网之鱼” 用optional 做一一匹配
1. 将十几个properties 归类，每一列单独组成字符串，作为cache key。对每一类匹配得到的资源做交集，即为符合所有properties 约束的资源。
2. 针对上一种方式，有些properties 作为基本属性，可以作为每一类 cache key的前缀

### 下发

下发什么？

1. 数据
2. 状态，比如提前终止一个文件下发，除新的请求无法获取文件外，还要通知已获取文件的设备禁用该文件

下发方式：

1. 全量，适用于一段时间有效文件 数量有限的业务
2. 增量

### 灰度下发

参见[abtest 系统设计汇总](http://qiankunli.github.io/2018/06/27/abtest.html) “如何扩大客户端abtest 的应用范围” 小节，在具备一个成熟的abtest 系统之后，灰度下发的事情 可以交给abtest 来统一完成。

### 支持多应用

### 支持多环境

### 数据的组织

对不同的业务 有以下场景：

1. 获取所有适配的文件
2. 获取某个类型的文件
3. 获取某个模块的文件

数据的组织 应该后台界面设计时 有所体现

## 基本准备

### 客户端信息 标准化

为了匹配 服务端“资源”，客户端请求是 要携带客户端信息，分为

1. 设备信息，比如设备id、andriod/ios、wifi/5g 等
2. 应用信息，比如app version、channel 等
3. 用户id，以此可以得到用户的画像信息

请求可以采用以下方式携带用户信息

1. cookie，难以在各个客户端 共用
2. 请求时 以json 描述用户信息

### 用户画像数据

通常需要根据用户画像数据 下发不同的资源，比如一个资源只下发给会员/新/儿童/上海用户等，此时需要

1. 使用统一的枚举类 代表这些画像信息
2. 画像信息归属于不同的业务组，应提供一个代理服务，聚合各类画像服务

画像数据如何获取？

1. 画像数据由客户端一次请求（加上必要的同步），持久存储，每次请求时携带用户画像数据
2. 每次请求时，由系统根据uid 调用画像聚合服务，向请求中注入画像信息，再进行业务匹配

### 安全

1. 防篡改

	* 更改返回json
	* 比如返回json 中有一个图片/视频的url，客户端请求拿到图片url 后再下载图片本身，容易被拦截为非法图片。


一般采用签名来防止 篡改，使用签名 要注意 包含转义字符字符串的 转义问题

### 权限管理

1. 超级管理员						可以做一切事情
2. app 管理员						app 范围内可以做一切事情
2. 文件某个组织维度的管理员			审核
2. 文件创建者		创建、修改

[初级权限系统设计](http://qiankunli.github.io/2017/12/29/permission_system.html)

权限的分配一般有两种方式：

1. 授权，实现方便，但坑在于：不够直观，开发人员经常被用户打扰要权限。PS：一个典型的维护 影响设计的例子。
2. 申请/审批

### 下发进度统计

### 测试设备管理

测试设备 可以访问到 未发布状态的资源，以备测试人员测试。
测试设备信息的 管理可以 在各个项目中共用。

### 精确到个人的日志记录

## 性能

### 缓存/打掉缓存

### 推拉

## 维护

### 警惕app 发版、新数据 对系统的影响

### 文档

平台支持项目一定要有文档，否则各种新人（不熟悉项目的人）的问题一定“教你做人”，文档包括

1. 设计文档
2. 接口文档
2. 常见错误文档

文档给谁看：

1. 接入新的应用时的开发人员
2. 业务使用方
3. 接管业务的新人
4. 测试人员，包括测试项目本身，或者业务项目（依赖了支持类项目）的测试

能界面设计上防止出错的，就别指望用户自觉了

文档表述上，可以多使用图片、脑图等表现力强的展现形式。**你或许很反感别人老是来问你认为很简单的事情，但那一定说明你文档写的不够好。**

## 项目管理

平台支持项目与 一般业务系统有以下不同：

1. 业务系统 需求来自产品经理，变动也来自产品经理，进度推进与资源协调 也一般由产品经理负责，技术相对省心
2. 业务系统 几乎没有 支持工作，平台支持系统多应用的接入 不可避免的会有一些调整及支持
3. 业务系统有问题，基本上线之后就可以发现，之后基本稳定，因此可以一人维护多个业务系统。支持类系统 则全周期内维护工作比较多，bug、权限授予、辅助数据查询等

也因此，平台支持类系统 在进度管理、人员分配上与 业务系统有所不同。

## 生命周期

平台支持类的项目，基本在跟着 客户端发版走，所以很多开发节点 要跟得上 客户端发版。

## 通用架构

前文都是从 单个项目来考虑的，多个类似的项目放在一起，我们就可以发现，其实有很多共用的部分。


### 一切皆配置

![](/public/upload/architecture/client_support_client_1.png)

所有业务 以配置形式存在，通过配置中心 下发到客户端，客户端同时拉取 用户画像数据，据此根据 相应的配置数据 进行 匹配，进而产生 相应的业务行为。

### 各自为政

![](/public/upload/architecture/client_support_client_2.png)

当然，在实际实施的过程作用，还可以有一个变种：即数据还是走配置中心全量下发，客户端另外发请求 查询匹配的数据（下发和匹配过程分开），此时服务端只返回匹配的id 即可。

### 对比

两个方案 一个侧重客户端，一个侧重服务端。理论上，第一个更轻省些，但对客户端的能力要求较高。业务架构 影响/被影响 团队架构，笔者第一次有如此切身的体会。  

## 支持类系统的意义

1. 快速复制一个具备 较强功能的 app 的能力，这体现了一个技术团队的战斗力

大致一个app，小到一个项目都需要支持类系统

1. 一个app 需要推送、文件下发、弹屏这类支持系统
2. 同一类型项目需要业务相关的支持系统，比如本文的系统都用到了匹配与统计等
2. 一个系统需要用户登录注册、权限 这类支持功能