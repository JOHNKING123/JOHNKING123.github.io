---

layout: post
title: 系统故障排查汇总及教训
category: 技术
tags: Architecture
keywords: abtest

---

## 简介（未完成）

源代码级的debug

系统级的debug

## 基本现象及通常原因

从用户角度看

1. 数据错误
2. 页面刷不出来

	* 请求超时

从报警角度看

1. tomcat 线程池打满
2. 大量异常

	* 本身异常
	* 依赖服务异常

3. 大量gc
4. mysql 大量超时

	通常原因是 耗时查询的sql 过多
5. redis 大量超时

	通常原因是网卡被打满，包括入宽打满和出宽打满。前者因为大量写入（通常是代码逻辑错误），后者通常因为服务负载较大，需要扩容。

## 排查故障的基本知识

jvm 基本组成，gc的原因分析 等

曾经作为一个coder，笔者虽然很热心的学习了这些知识，但实际用的少，

## 完备的系统感知能力

感知什么？



一个示例。

完备的监控，笔者曾碰到一次事故，tomcat 线程池满了，可以判断出来某个请求的处理很慢。报警系统同时反馈redis 连接池连接获取超时，进而可以定位是redis 的原因。然后运维说，redis 网卡打满了，但尚未定位是入宽打满还是出宽打满，我当时觉得自己的系统缓存用的少，应该是别人的原因，因此回去睡觉了。但后来 确实我这边 大量的写入导致的。

我自己的代码肯定是有问题，锅甩不掉。换个较角度看，如果 监控系统 监控redis 的带宽，并设定阈值报警，同时能够分析入宽来源方的数据量，则可以极大的减少定位问题的时间，并找到相关的开发解决问题。

此外，从中我们还可以看到：

1. 从运维的角度看，redis 资源的分配 应设定几条基本原则，其中重要的原则之一就是方便定位问题。
2. 大部分时候 我们还是在受限的资源下做事情，监控/报警系统不完备或者没有，这都不是出现事故的理由。还以上述问题 为例，仅以完成代码功能来说，业务 ==> db 即可。为了挺高性能：业务 ==> 缓存 ==> db。 缓存是共用的，那么为了减少依赖提高可靠性。可以： 业务 ==> local cache ==> 缓存 ==> db。 同时根据业务做好降级熔断措施。
3. 所以，为了提高一段代码，功能实现、高性能、可靠性、可扩展性，你的脑子里一共有几个维度？ 根据项目的发展阶段，各个维度的重要性如何取舍？

## 系统实现

1. 系统层面的三高

	* 设计计划 找多个人过一下
2. 代码层面上

	1. 对while循环、递归等保持警惕
	2. 感觉这块儿会出问题，就通常会出问题
	3. 测试类、代码review 等层面上 提高代码的正确性
