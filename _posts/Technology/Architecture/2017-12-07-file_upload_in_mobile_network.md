---

layout: post
title: 移动网络下的文件上传
category: 技术
tags: Architecture
keywords: fileupload

---

## 简介

1. 移动网络(相对有线网络)的一些特点
2. 我们用户上传场景的特点

	* 大部分用户应该处于一个稳定的网络环境下，但如果将上传系统作为一个公共组件，以后聊天等也会用的话，则需要考虑这个问题。

[腾讯原创分享(一)：如何大幅提升移动网络下手机QQ的图片传输速度和成功率](http://www.52im.net/thread-675-1-1.html)要点：

1. 网络好时提高速度率；网络差时提高成功率
2. 移动网络容易出现“跳变”，下一秒中的传送速度可能降到前一秒的几十分之一，RTO（超时重传机制）容易因为超时导致大量失败
3. 移动网络里经常会有“网络真空 (NV)”，即便信号满格也传不出去 1 个字节。

## 笔者曾经实现的一个简单方案

断点续传  ==> 转发host ==> executor host 将文件落盘，上传fastfs

缺点：

1. 转发host 不够高效
2. netty executor中存在阻塞逻辑

	* netty中直接调用fdfs上传文件，原因：要向客户端返回文件id

3. 数据采集、统计和查询能力几乎没有

当时的一些考虑：

1. 使用tcp的理由：http容易被运营商劫持
2. 有一个专门的转发host：对外端口有限
3. 断点续传：简化客户端开发


## 要理清的几个问题

1. 是否采用分片，分片是自定义协议，还是http chunk。[如何让你产品的用户拥有一流的上传体验](https://zhuanlan.zhihu.com/p/28306136)网易云采用自定义的http方式

	* 4g和wifi网络下，分片大小不同

2. 是否保留转发
3. 接收端避免随机读写数据数据。

	* 接收端将接收到的数据，写入内存即返回，由类似kafka的accumulator将内存中的数据整理落盘，或者由内存直接上传fastfs
	* 根据接收文件块的顺序 顺序写入文件，同时记录文件块与实际文件中的位置的关系，在上传文件时，重新恢复成原文件
4. 整个上传过程中，http与tcp的关系。哪些信息通过http方式完成，哪些信息通过tcp方式完成？tcp方式是否需要返回文件唯一标识
5. 上传系统的目标：公司各个场景的统一的上传平台。包括录音，群聊的图片、语音，私信的语音，富音频等


对客户端的要求：
对服务端的要求：